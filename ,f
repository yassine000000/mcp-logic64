warning: in the working copy of 'apps/studio/package.json', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'node_modules/studio/package.json', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/apps/kernel/src/index.ts b/apps/kernel/src/index.ts[m
[1mindex ebb81f0..6e605ae 100644[m
[1m--- a/apps/kernel/src/index.ts[m
[1m+++ b/apps/kernel/src/index.ts[m
[36m@@ -1,104 +1,138 @@[m
 import { serve } from '@hono/node-server'[m
 import { Hono } from 'hono'[m
 import { cors } from 'hono/cors'[m
[31m-import { bearerAuth } from 'hono/bearer-auth'[m
[31m-import { createClient } from '@supabase/supabase-js'[m
 import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'[m
 import { Transport } from '@modelcontextprotocol/sdk/shared/transport.js'[m
 import { z } from 'zod'[m
 import { randomUUID } from 'crypto'[m
[31m-import dotenv from 'dotenv';[m
[31m-import { HTTPException } from 'hono/http-exception'[m
[32m+[m[32mimport dotenv from 'dotenv'[m
[32m+[m[32mimport { readFileSync } from 'fs'[m
[32m+[m[32mimport { join } from 'path'[m
[32m+[m[32mimport { LOGIC64_ARCHITECTURE } from './logic64-rules.js'[m
 [m
 dotenv.config();[m
 [m
 const app = new Hono()[m
[32m+[m[32mapp.use('/*', cors())[m
 [m
[31m-// --- Configuration ---[m
[31m-const SUPABASE_URL = process.env.SUPABASE_URL || '';[m
[31m-const SUPABASE_KEY = process.env.SUPABASE_SERVICE_KEY || ''; // Must be service role key for the Kernel to read all projects by API Key[m
[31m-[m
[31m-const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);[m
[32m+[m[32mconst mcp = new McpServer({[m
[32m+[m[32m  name: "Logic64 Governance Kernel",[m
[32m+[m[32m  version: "1.0.0"[m
[32m+[m[32m})[m
 [m
[31m-app.use('/*', cors())[m
[32m+[m[32m// --- MCP Resources: Documentation Access ---[m
[32m+[m
[32m+[m[32mconst DOCS_ROOT = join(process.cwd(), '../../_archive/MCP-Core/docs');[m
[32m+[m
[32m+[m[32m// Register resource handlers[m
[32m+[m[32mmcp.server.setRequestHandler({[m
[32m+[m[32m  method: "resources/list",[m
[32m+[m[32m  handler: async () => ({[m
[32m+[m[32m    resources: [[m
[32m+[m[32m      {[m
[32m+[m[32m        uri: "logic64://context-map",[m
[32m+[m[32m        name: "Logic64 Context Map",[m
[32m+[m[32m        description: "Index of all architectural documentation",[m
[32m+[m[32m        mimeType: "text/markdown"[m
[32m+[m[32m      },[m
[32m+[m[32m      {[m
[32m+[m[32m        uri: "logic64://system-architecture",[m
[32m+[m[32m        name: "System Architecture Specification",[m
[32m+[m[32m        description: "The 7-layer architecture and Phase-Shift Protocol",[m
[32m+[m[32m        mimeType: "text/markdown"[m
[32m+[m[32m      }[m
[32m+[m[32m    ][m
[32m+[m[32m  })[m
[32m+[m[32m});[m
 [m
[31m-// --- Middleware: API Key Enforcement ---[m
[31m-// The user adds the API Key in Cursor/Claude. [m
[31m-// We expect it either in the Authorization header (Bearer) or a custom header/query param.[m
[31m-// For SSE, it's often easier to pass via Query Param as EventSource doesn't easily support headers.[m
[31m-// We will support Query Param 'apiKey' for the SSE connection.[m
[32m+[m[32mmcp.server.setRequestHandler({[m
[32m+[m[32m  method: "resources/read",[m
[32m+[m[32m  handler: async (request: any) => {[m
[32m+[m[32m    const uri = request.params.uri;[m
 [m
[31m-const apiKeyAuth = async (c: any, next: any) => {[m
[31m-  const urlApiKey = c.req.query('apiKey');[m
[32m+[m[32m    if (uri === "logic64://context-map") {[m
[32m+[m[32m      const content = readFileSync(join(DOCS_ROOT, 'CONTEXT_MAP.md'), 'utf-8');[m
[32m+[m[32m      return { contents: [{ uri, mimeType: "text/markdown", text: content }] };[m
[32m+[m[32m    }[m
 [m
[31m-  if (!urlApiKey) {[m
[31m-    // If not in query, check header (standard requests)[m
[31m-    const header = c.req.header('Authorization');[m
[31m-    if (!header || !header.startsWith('Bearer ')) {[m
[31m-      return c.text('Missing API Key', 401);[m
[32m+[m[32m    if (uri === "logic64://system-architecture") {[m
[32m+[m[32m      const content = readFileSync(join(DOCS_ROOT, 'system_architecture.md'), 'utf-8');[m
[32m+[m[32m      return { contents: [{ uri, mimeType: "text/markdown", text: content }] };[m
     }[m
[32m+[m
[32m+[m[32m    throw new Error(`Unknown resource: ${uri}`);[m
   }[m
[32m+[m[32m});[m
 [m
[31m-  const apiKey = urlApiKey || c.req.header('Authorization')?.split(' ')[1];[m
[32m+[m[32m// --- MCP Tools ---[m
 [m
[31m-  // Validate API Key against Supabase[m
[31m-  const { data, error } = await supabase[m
[31m-    .from('projects')[m
[31m-    .select('*')[m
[31m-    .eq('api_key', apiKey)[m
[31m-    .single();[m
[32m+[m[32mmcp.tool("get_architecture_vision",[m
[32m+[m[32m  {},[m
[32m+[m[32m  async () => {[m
[32m+[m[32m    const summary = `[m
[32m+[m[32m# Logic64 Architecture Vision[m
 [m
[31m-  if (error || !data) {[m
[31m-    return c.text('Invalid API Key', 403);[m
[31m-  }[m
[32m+[m[32m**Project**: ${LOGIC64_ARCHITECTURE.project.name} v${LOGIC64_ARCHITECTURE.project.version}[m
[32m+[m[32m**Purpose**: ${LOGIC64_ARCHITECTURE.project.description}[m
 [m
[31m-  // Attach project context to the request (and potentially the session)[m
[31m-  c.set('project', data);[m
[31m-  await next();[m
[31m-}[m
[32m+[m[32m## Stack[m
[32m+[m[32mRequired: ${LOGIC64_ARCHITECTURE.stack.required.join(', ')}[m
[32m+[m[32mForbidden: ${LOGIC64_ARCHITECTURE.stack.forbidden.join(', ')}[m
 [m
[31m-const mcp = new McpServer({[m
[31m-  name: "Logic64 Cloud Kernel",[m
[31m-  version: "1.0.0"[m
[31m-})[m
[32m+[m[32m## Structure[m
[32m+[m[32m${Object.entries(LOGIC64_ARCHITECTURE.architecture.structure).map(([k, v]) => `- ${k}: ${v}`).join('\n')}[m
 [m
[31m-// --- Tools ---[m
[32m+[m[32m## Governance Principle[m
[32m+[m[32m${LOGIC64_ARCHITECTURE.governance.principle}[m
 [m
[31m-mcp.tool("consult_architect",[m
[31m-  {[m
[31m-    intent: z.string().describe("The user's architectural intent"),[m
[31m-  },[m
[31m-  async ({ intent }, { requestContext }) => {[m
[31m-    // We need to access the project context here.[m
[31m-    // However, MCP tools don't directly access the Hono context of the SSE connection.[m
[31m-    // Solution: We pass the rules or project_id in the session/transport scope if possible, [m
[31m-    // or we query Supabase again (stateless) if we had the API key.[m
[31m-    // For this implementation, we will mock the "Context Injection" by assuming [m
[31m-    // we can retrieve the active project rules.[m
[31m-    // In a stateless MCP over SSE, the session is persistent. [m
[31m-    // We'll store the project rules in the transport session map.[m
[31m-[m
[31m-    // *Fetching logic simulated for now as we are inside the Tool callback scope*[m
[31m-    // Ideally, we'd look up the session's cached rules.[m
[32m+[m[32m## Available Documentation[m
[32m+[m[32mUse MCP Resources to access detailed docs:[m
[32m+[m[32m- logic64://context-map - Index of all documentation[m
[32m+[m[32m- logic64://system-architecture - Detailed architecture spec[m
 [m
[31m-    console.log(`[MCP] Consulting architect for: ${intent}`);[m
[32m+[m[32m## Next Steps[m
[32m+[m[32m1. Read the Context Map to understand the documentation structure[m
[32m+[m[32m2. Before making ANY code changes, consult specific docs via Resources[m
[32m+[m[32m3. Use consult_architect tool for intent-specific rules[m
[32m+[m[32m4. Use verify_compliance before submitting code[m
[32m+[m[32m`;[m
 [m
[31m-    // Fallback/Mock rules for demonstration if DB is empty[m
[31m-    const { data: project } = await supabase.from('projects').select('*').limit(1).single();[m
[31m-    const rules = project?.architecture_rules || {[m
[31m-      stack: ["Next.js", "Supabase", "Tailwind"],[m
[31m-      concepts: [{ domain: "General", triggers: [], rules: ["Adhere to Clean Architecture"] }][m
[32m+[m[32m    return {[m
[32m+[m[32m      content: [{ type: "text", text: summary }][m
     };[m
[32m+[m[32m  }[m
[32m+[m[32m);[m
[32m+[m
[32m+[m[32mmcp.tool("consult_architect",[m
[32m+[m[32m  { intent: z.string().describe("What you want to build (e.g., 'database query', 'API endpoint')") },[m
[32m+[m[32m  async ({ intent }) => {[m
[32m+[m[32m    console.log(`[MCP] Consulting architect for: ${intent}`);[m
[32m+[m
[32m+[m[32m    const matchedConcepts = LOGIC64_ARCHITECTURE.concepts.filter(concept =>[m
[32m+[m[32m      concept.triggers.some(trigger => intent.toLowerCase().includes(trigger))[m
[32m+[m[32m    );[m
[32m+[m
[32m+[m[32m    if (matchedConcepts.length === 0) {[m
[32m+[m[32m      return {[m
[32m+[m[32m        content: [{[m
[32m+[m[32m          type: "text",[m
[32m+[m[32m          text: `No specific rules found for "${intent}". General guidance:\n- Follow the stack requirements\n- Consult the documentation via Resources before proceeding`[m
[32m+[m[32m        }][m
[32m+[m[32m      };[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const guidance = matchedConcepts.map(concept =>[m
[32m+[m[32m      `**${concept.domain}**:\n${concept.rules.map(r => `- ${r}`).join('\n')}`[m
[32m+[m[32m    ).join('\n\n');[m
 [m
     return {[m
       content: [{[m
         type: "text",[m
[31m-        // @ts-ignore[m
[31m-        text: `Architectural Guidance for '${intent}':\nBased on Project Rules:\nStack: ${rules.stack.join(', ')}\nConstraint: ${JSON.stringify(rules.concepts)}`[m
[32m+[m[32m        text: `Architectural Guidance for "${intent}":\n\n${guidance}`[m
       }][m
[31m-    }[m
[32m+[m[32m    };[m
   }[m
[31m-)[m
[32m+[m[32m);[m
 [m
 mcp.tool("verify_compliance",[m
   {[m
[36m@@ -107,17 +141,46 @@[m [mmcp.tool("verify_compliance",[m
   },[m
   async ({ code_snippet, target_file }) => {[m
     console.log(`[MCP] Verifying ${target_file}`);[m
[31m-    const isCompliant = !code_snippet.includes("style={{");[m
 [m
[31m-    if (isCompliant) {[m
[31m-      return { content: [{ type: "text", text: "Approved: code follows guidelines." }] };[m
[32m+[m[32m    const violations: string[] = [];[m
[32m+[m
[32m+[m[32m    // Check for forbidden imports[m
[32m+[m[32m    LOGIC64_ARCHITECTURE.stack.forbidden.forEach(forbidden => {[m
[32m+[m[32m      const importPattern = new RegExp(`import.*['"]${forbidden.toLowerCase()}['"]`, 'i');[m
[32m+[m[32m      if (importPattern.test(code_snippet)) {[m
[32m+[m[32m        violations.push(`FORBIDDEN: Import of '${forbidden}' detected. Use approved stack instead.`);[m
[32m+[m[32m      }[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    // Check for inline styles (Tailwind enforcement)[m
[32m+[m[32m    if (code_snippet.includes('style={{')) {[m
[32m+[m[32m      violations.push('FORBIDDEN: Inline styles detected. Use Tailwind classes.');[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Check for CSS Modules[m
[32m+[m[32m    if (code_snippet.includes('.module.css') || code_snippet.includes('.module.scss')) {[m
[32m+[m[32m      violations.push('FORBIDDEN: CSS Modules detected. Use Tailwind instead.');[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (violations.length === 0) {[m
[32m+[m[32m      return {[m
[32m+[m[32m        content: [{[m
[32m+[m[32m          type: "text",[m
[32m+[m[32m          text: "âœ… APPROVED: Code follows Logic64 architectural guidelines."[m
[32m+[m[32m        }][m
[32m+[m[32m      };[m
     } else {[m
[31m-      return { content: [{ type: "text", text: "Rejected: Inline styles are forbidden. Use Tailwind classes." }] }[m
[32m+[m[32m      return {[m
[32m+[m[32m        content: [{[m
[32m+[m[32m          type: "text",[m
[32m+[m[32m          text: `âŒ REJECTED: Code violates architectural rules:\n\n${violations.map((v, i) => `${i + 1}. ${v}`).join('\n')}`[m
[32m+[m[32m        }][m
[32m+[m[32m      };[m
     }[m
   }[m
[31m-)[m
[32m+[m[32m);[m
 [m
[31m-// --- Custom SSE Transport ---[m
[32m+[m[32m// --- SSE Transport ---[m
 [m
 class HonoSSETransport implements Transport {[m
   private sessionId: string;[m
[36m@@ -131,9 +194,7 @@[m [mclass HonoSSETransport implements Transport {[m
     this.writer = writer;[m
   }[m
 [m
[31m-  async start() {[m
[31m-    // Ready[m
[31m-  }[m
[32m+[m[32m  async start() { }[m
 [m
   async close() {[m
     this.onclose?.();[m
[36m@@ -158,28 +219,19 @@[m [mconst transports = new Map<string, HonoSSETransport>();[m
 [m
 // --- Routes ---[m
 [m
[31m-// The SSE Endpoint matches the spec: "Logic64 Server: checks API Key"[m
[31m-app.get('/sse', apiKeyAuth, async (c) => {[m
[32m+[m[32mapp.get('/sse', async (c) => {[m
   const sessionId = randomUUID();[m
[31m-  console.log(`[SSE] New connection: ${sessionId}`);[m
[32m+[m[32m  console.log(`[SSE] New Logic64 session: ${sessionId}`);[m
 [m
[31m-  // Create transport[m
   return c.streamText(async (stream) => {[m
     const transport = new HonoSSETransport(sessionId, async (data) => {[m
       await stream.write(data);[m
     });[m
     transports.set(sessionId, transport);[m
 [m
[31m-    // Connect transport to MCP[m
     await mcp.connect(transport);[m
[31m-[m
[31m-    // Send the endpoint event so the client knows where to POST messages[m
[31m-    // Note: We include the apiKey in the return URL or expect headers, [m
[31m-    // but standard MCP clients usually just POST to the URL provided.[m
[31m-    // We will append sessionId.[m
     await stream.write(`event: endpoint\ndata: /messages?sessionId=${sessionId}\n\n`);[m
 [m
[31m-    // Keep-alive loop[m
     const interval = setInterval(async () => {[m
       try {[m
         await stream.write(': keep-alive\n\n');[m
[36m@@ -188,15 +240,13 @@[m [mapp.get('/sse', apiKeyAuth, async (c) => {[m
       }[m
     }, 15000);[m
 [m
[31m-    // Cleanup[m
     stream.onAbort(async () => {[m
[31m-      console.log(`[SSE] Aborted: ${sessionId}`);[m
[32m+[m[32m      console.log(`[SSE] Session ended: ${sessionId}`);[m
       clearInterval(interval);[m
       transports.delete(sessionId);[m
       await transport.close();[m
     });[m
 [m
[31m-    // Wait forever (until abort)[m
     await new Promise(() => { });[m
   });[m
 });[m
[36m@@ -219,10 +269,10 @@[m [mapp.post('/messages', async (c) => {[m
 [m
 // --- Start Server ---[m
 [m
[31m-const port = 3001[m
[31m-console.log(`Logic64 Cloud Kernel running on port ${port}`)[m
[32m+[m[32mconst port = 3001;[m
[32m+[m[32mconsole.log(`Logic64 Governance Kernel running on port ${port}`);[m
 [m
 serve({[m
   fetch: app.fetch,[m
   port[m
[31m-})[m
[32m+[m[32m});[m
[1mdiff --git a/apps/studio/package.json b/apps/studio/package.json[m
[1mindex e5bac24..e180ffc 100644[m
[1m--- a/apps/studio/package.json[m
[1m+++ b/apps/studio/package.json[m
[36m@@ -9,17 +9,18 @@[m
     "lint": "eslint"[m
   },[m
   "dependencies": {[m
[31m-    "next": "16.1.4",[m
[31m-    "react": "19.2.3",[m
[31m-    "react-dom": "19.2.3",[m
[31m-    "ai": "^4.1.17",[m
     "@ai-sdk/anthropic": "^1.1.6",[m
     "@ai-sdk/openai": "^1.1.9",[m
[31m-    "zod": "^3.24.1",[m
     "@supabase/supabase-js": "^2.48.1",[m
[31m-    "lucide-react": "^0.474.0",[m
[32m+[m[32m    "ai": "^4.1.17",[m
     "clsx": "^2.1.1",[m
[31m-    "tailwind-merge": "^3.0.1"[m
[32m+[m[32m    "lucide-react": "^0.474.0",[m
[32m+[m[32m    "next": "16.1.4",[m
[32m+[m[32m    "react": "19.2.3",[m
[32m+[m[32m    "react-dom": "19.2.3",[m
[32m+[m[32m    "reactflow": "^11.11.4",[m
[32m+[m[32m    "tailwind-merge": "^3.0.1",[m
[32m+[m[32m    "zod": "^3.24.1"[m
   },[m
   "devDependencies": {[m
     "@tailwindcss/postcss": "^4",[m
[36m@@ -31,4 +32,4 @@[m
     "tailwindcss": "^4",[m
     "typescript": "^5"[m
   }[m
[31m-}[m
\ No newline at end of file[m
[32m+[m[32m}[m
[1mdiff --git a/node_modules/.package-lock.json b/node_modules/.package-lock.json[m
[1mindex 3e4a577..b815fc8 100644[m
[1m--- a/node_modules/.package-lock.json[m
[1m+++ b/node_modules/.package-lock.json[m
[36m@@ -33,6 +33,7 @@[m
                 "next": "16.1.4",[m
                 "react": "19.2.3",